<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tutor Availability Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#667eea 100%);background-size:400% 400%;animation:gradientShift 15s ease infinite;min-height:100vh;color:#333;padding:20px}
    @keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .container{max-width:1200px;margin:0 auto}
    .header{background:rgba(255,255,255,.95);border-radius:24px;padding:40px;margin-bottom:30px;box-shadow:0 20px 60px rgba(0,0,0,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2);position:relative;overflow:hidden;text-align:center}
    .header::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2,#667eea);background-size:200% 100%;animation:shimmer 2s infinite}
    @keyframes shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
    .header h1{color:#2d3748;font-size:2.8rem;font-weight:800;margin-bottom:15px;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:#718096;font-size:1.1rem;font-weight:500}

    /* settings gear */
    .settings-btn{
      position:absolute;top:15px;right:15px;font-size:1.6rem;text-decoration:none;background:rgba(255,255,255,.85);
      border-radius:50%;padding:8px 10px;box-shadow:0 4px 10px rgba(0,0,0,.15);transition:all .2s ease;color:#2d3748
    }
    .settings-btn:hover{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;transform:rotate(90deg)}

    .filters-container{background:rgba(255,255,255,.95);border-radius:20px;padding:30px;margin-bottom:30px;box-shadow:0 15px 45px rgba(0,0,0,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2);position:relative;overflow:visible}
    .filters-container::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(102,126,234,.03),rgba(118,75,162,.03));opacity:1}
    .filters-grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px;position:relative;z-index:1}
    .filter-group label{display:block;font-weight:700;margin-bottom:12px;color:#2d3748;font-size:1.1rem}
    .filter-group select,.filter-group input{width:100%;max-width:360px;padding:12px 16px;border:2px solid #e2e8f0;border-radius:16px;font-size:16px;font-weight:600;transition:all .3s ease;background:rgba(255,255,255,.9);color:#2d3748}
    .filter-group select:focus,.filter-group input:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 4px rgba(102,126,234,.1);transform:translateY(-2px)}
    .filter-row{display:flex;gap:10px;align-items:center}
    .btn{padding:12px 16px;border-radius:12px;border:2px solid #e2e8f0;background:#fff;font-weight:700;cursor:pointer}
    .btn:hover{border-color:#cbd5e0}
    .calendar-container{background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 15px 45px rgba(0,0,0,.15);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.2);position:relative;overflow:hidden}
    .calendar-container::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2,#667eea);background-size:200% 100%;animation:shimmer 2s infinite}
    .fc{position:relative;z-index:1}
    .fc .fc-toolbar{margin-bottom:25px}
    .fc .fc-toolbar-title{font-size:1.8rem;font-weight:800;color:#2d3748;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .fc .fc-button-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:12px;font-weight:600;padding:8px 16px;transition:all .3s ease;box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .fc .fc-button-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(102,126,234,.4);background:linear-gradient(135deg,#5a67d8 0%,#6b46c1 100%)}
    .fc .fc-scrollgrid{border-radius:16px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,.1)}
    .fc .fc-col-header-cell{background:rgba(248,250,252,.9);border-color:rgba(226,232,240,.5);font-weight:700;color:#4a5568;padding:15px 8px}
    .fc .fc-daygrid-day,.fc .fc-timegrid-slot{background:rgba(255,255,255,.9);border-color:rgba(226,232,240,.3);transition:background-color .2s ease}
    .fc .fc-daygrid-day:hover,.fc .fc-timegrid-slot:hover{background:rgba(102,126,234,.05)}
    .fc .fc-day-today{background:linear-gradient(135deg,rgba(102,126,234,.08),rgba(118,75,162,.08))}
    .fc .fc-day-today .fc-daygrid-day-number{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-weight:700;margin:4px}
    .fc-event{border:none;border-radius:8px;font-weight:600;font-size:.85rem;box-shadow:0 3px 12px rgba(0,0,0,.15);transition:all .3s ease;cursor:pointer;margin:2px 0}
    .fc-event:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .loading-overlay{position:absolute;inset:0;background:rgba(255,255,255,.9);display:flex;justify-content:center;align-items:center;z-index:1000;border-radius:20px;backdrop-filter:blur(10px)}
    .loading-spinner{width:50px;height:50px;border:4px solid rgba(102,126,234,.2);border-left:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .loading-text{margin-left:15px;font-weight:600;color:#4a5568;font-size:1.1rem}
    .error-message{background:rgba(254,215,215,.9);color:#742a2a;padding:20px;border-radius:12px;border:2px solid rgba(254,178,178,.5);text-align:center;font-weight:600;margin:20px 0}
    .connection-status{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:20px;font-size:.9rem;font-weight:600;z-index:1000;transition:all .3s ease;backdrop-filter:blur(10px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
    .connection-status.connected{background:rgba(198,246,213,.95);color:#22543d;border:2px solid rgba(154,230,180,.5)}
    .connection-status.error{background:rgba(254,215,215,.95);color:#742a2a;border:2px solid rgba(254,178,178,.5)}
    .connection-status.loading{background:rgba(254,235,200,.95);color:#7c2d12;border:2px solid rgba(251,211,141,.5)}
    .fc-popover{background:rgba(0,0,0,.9);border:none;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,.3);backdrop-filter:blur(10px)}
    .fc-popover-header{background:transparent;border:none;color:#fff;font-weight:600;padding:12px 16px 8px}
    .fc-popover-body{color:rgba(255,255,255,.9);padding:8px 16px 12px}
    @media (max-width:768px){body{padding:10px}.header{padding:25px 20px}.header h1{font-size:1.8rem}.filters-container,.calendar-container{padding:20px}.connection-status{position:relative;top:auto;right:auto;margin-bottom:20px;display:inline-block}.fc .fc-toolbar{flex-direction:column;gap:15px}.fc .fc-toolbar-title{font-size:1.4rem;order:-1}}
    .tutor-legend{margin-top:25px;padding-top:25px;border-top:2px solid rgba(226,232,240,.3)}
    .legend-title{font-weight:700;color:#2d3748;margin-bottom:15px;font-size:1.1rem}
    .legend-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .legend-item{display:flex;align-items:center;gap:10px;font-weight:600;color:#4a5568;padding:8px 12px;background:rgba(248,250,252,.5);border-radius:8px;transition:all .2s ease;cursor:pointer;user-select:none;outline:2px solid transparent}
    .legend-item:hover{background:rgba(248,250,252,.8);transform:translateY(-1px)}
    .legend-item.selected{outline:2px solid rgba(102,126,234,.55);background:rgba(102,126,234,.08)}
    .legend-color{width:16px;height:16px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.2)}

    /* suggestions */
    .subject-suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1px solid rgba(226,232,240,.9);border-radius:8px;max-height:240px;overflow-y:auto;z-index:1000;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .subject-suggestions .item{padding:8px 12px;cursor:pointer;font-size:14px}
    .subject-suggestions .item:hover,.subject-suggestions .item.active{background:rgba(248,250,252,.9)}

    .filters-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .filters-bar .control,.filters-bar select,.filters-bar input,.filters-bar button{margin:0;vertical-align:middle}
    @media (max-width:720px){.filters-bar{gap:6px}}
    .inline-flex-pair{display:inline-flex;gap:8px;align-items:center}

    /* Email Blast Button */
    .email-blast-btn{
      background:linear-gradient(135deg,#667eea,#764ba2);
      color:#fff;border:none;border-radius:16px;
      padding:12px 24px;font-weight:700;font-size:1rem;
      cursor:pointer;box-shadow:0 6px 20px rgba(102,126,234,.4);
      transition:all .3s ease;display:inline-flex;align-items:center;gap:8px;
      animation:emailPulse 2s ease-in-out infinite;
      white-space:nowrap;
    }
    @keyframes emailPulse{0%,100%{box-shadow:0 6px 20px rgba(102,126,234,.4)}50%{box-shadow:0 6px 30px rgba(102,126,234,.6)}}
    .email-blast-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(102,126,234,.5)}
    .email-blast-btn:active{transform:translateY(0);box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .email-blast-btn .icon{font-size:1.2rem;animation:emailBounce 1s ease-in-out infinite}
    @keyframes emailBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    /* Email Modal */
    .email-modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;justify-content:center;align-items:center;z-index:2000;
      backdrop-filter:blur(8px);animation:fadeIn .3s ease
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .email-modal-overlay.show{display:flex}
    .email-modal{
      background:#fff;border-radius:24px;padding:40px;
      max-width:600px;width:90%;max-height:90vh;overflow-y:auto;
      box-shadow:0 25px 60px rgba(0,0,0,.3);
      animation:slideUp .3s ease;position:relative
    }
    @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .email-modal h2{
      color:#2d3748;font-size:1.8rem;margin-bottom:10px;
      background:linear-gradient(135deg,#667eea,#764ba2);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .email-modal .subtitle{color:#718096;margin-bottom:25px;font-size:.95rem}
    .email-modal .form-group{margin-bottom:20px}
    .email-modal label{display:block;font-weight:700;color:#2d3748;margin-bottom:8px;font-size:.95rem}
    .email-modal input,.email-modal textarea{
      width:100%;padding:12px 16px;border:2px solid #e2e8f0;
      border-radius:12px;font-size:15px;transition:all .3s ease;
      font-family:inherit;background:#fff
    }
    .email-modal input:focus,.email-modal textarea:focus{
      outline:none;border-color:#667eea;
      box-shadow:0 0 0 4px rgba(102,126,234,.1)
    }
    .email-modal textarea{min-height:120px;resize:vertical}
    .email-modal .tutor-list{
      background:rgba(248,250,252,.8);border-radius:12px;
      padding:15px;margin-bottom:20px;max-height:150px;overflow-y:auto;
      border:1px solid rgba(226,232,240,.5)
    }
    .email-modal .tutor-list strong{display:block;margin-bottom:8px;color:#2d3748}
    .email-modal .tutor-tag{
      display:inline-block;background:linear-gradient(135deg,#667eea,#764ba2);
      color:#fff;padding:6px 12px;border-radius:8px;margin:4px;
      font-size:.85rem;font-weight:600
    }
    .email-modal .button-group{display:flex;gap:12px;margin-top:25px}
    .email-modal .btn-primary,.email-modal .btn-secondary{
      flex:1;padding:14px 24px;border:none;border-radius:12px;
      font-weight:700;font-size:1rem;cursor:pointer;transition:all .3s ease
    }
    .email-modal .btn-primary{
      background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
      box-shadow:0 4px 15px rgba(102,126,234,.3)
    }
    .email-modal .btn-primary:hover{
      transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)
    }
    .email-modal .btn-secondary{background:#e2e8f0;color:#2d3748}
    .email-modal .btn-secondary:hover{background:#cbd5e0}
    .email-modal .close-btn{
      position:absolute;top:20px;right:20px;background:none;
      border:none;font-size:1.5rem;cursor:pointer;color:#718096;
      width:32px;height:32px;border-radius:50%;
      transition:all .2s ease;display:flex;align-items:center;justify-content:center
    }
    .email-modal .close-btn:hover{background:rgba(226,232,240,.5);color:#2d3748}

    /* Success/Error Toast */
    .toast{
      position:fixed;top:80px;right:20px;
      padding:16px 24px;border-radius:16px;
      font-weight:600;z-index:3000;
      box-shadow:0 8px 25px rgba(0,0,0,.2);
      animation:slideInRight .3s ease;
      max-width:400px;backdrop-filter:blur(10px)
    }
    @keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{background:rgba(198,246,213,.95);color:#22543d;border:2px solid rgba(154,230,180,.5)}
    .toast.error{background:rgba(254,215,215,.95);color:#742a2a;border:2px solid rgba(254,178,178,.5)}
    .toast.hide{animation:slideOutRight .3s ease forwards}
    @keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}

    @media (max-width:768px){
      .email-blast-btn{width:100%;justify-content:center;margin-bottom:12px}
      .email-modal{padding:30px 20px}
      .email-modal .button-group{flex-direction:column}
      .filters-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div id="connectionStatus" class="connection-status loading">üîÑ Loading calendar...</div>

  <div class="container">
    <div class="header">
      <h1>üìÖ Tutor Availability Calendar</h1>
      <p>View real-time tutor availability and schedule appointments</p>
      <a href="settings.html" class="settings-btn" title="Settings" aria-label="Settings">‚öôÔ∏è</a>
    </div>

    <div class="filters-container">
      <div style="margin-bottom:20px">
        <button id="emailBlastBtn" class="email-blast-btn" title="Send email to filtered tutors">
          <span class="icon">üìß</span>
          <span>Email Blast to Selected Tutors</span>
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-group">
          <label for="tutorFilter">üéì Filter by Tutor:</label>
          <div class="inline-flex-pair">
            <select id="tutorFilter">
              <option value="all">All Tutors</option>
            </select>
            <button id="toggleTutor2" class="btn" type="button" title="Compare two tutors" style="padding:8px 10px">Add second tutor</button>
          </div>
          <div class="filter-row" style="margin-top:8px;gap:8px;">
            <select id="tutorFilter2" style="display:none;min-width:200px;">
              <option value="none">‚Äî Select second tutor ‚Äî</option>
            </select>
            <button id="removeTutor2" class="btn" type="button" title="Remove second tutor" style="display:none;padding:6px 8px;width:34px;height:34px;line-height:1">√ó</button>
            <span id="tutor2Hint" style="display:none;color:#718096;font-size:12px">compare tutors</span>
          </div>
        </div>

        <div class="filter-group">
          <label for="subjectFilter">üìò Filter by Subject :</label>
          <div class="filter-row" style="position:relative">
            <input id="subjectFilter" placeholder="Type subject (English, Algebra, Bio)" autocomplete="off"/>
            <div id="subjectSuggestions" class="subject-suggestions" style="display:none"></div>
            <button id="applySubject" class="btn" title="Search">Search</button>
            <button id="clearSubject" class="btn" title="Clear subject" style="padding:6px 10px;width:36px;height:36px;line-height:1;font-size:16px;display:inline-flex;align-items:center;justify-content:center">√ó</button>
          </div>
        </div>
      </div>
    </div>

    <div class="calendar-container">
      <div id="loadingOverlay" class="loading-overlay" style="display:none">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading availability...</div>
      </div>

      <div id="calendar"></div>

      <div class="tutor-legend">
        <div class="legend-title">üë• Tutor Color Legend <span style="font-weight:500;color:#718096;font-size:.9rem">Tip: Shift-click to select multiple</span></div>
        <div id="tutorLegend" class="legend-grid"></div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="email-modal-overlay">
    <div class="email-modal">
      <button class="close-btn" id="closeEmailModal" aria-label="Close">√ó</button>
      <h2>üìß Send Email Blast</h2>
      <p class="subtitle">Send an email to the selected tutors</p>
      
      <div class="tutor-list" id="recipientList">
        <strong>Recipients:</strong>
        <div id="recipientTags"></div>
      </div>

      <div class="form-group">
        <label for="emailSubject">Subject Line:</label>
        <input type="text" id="emailSubject" placeholder="Enter email subject..." value="STD Email Blast: ">
      </div>

      <div class="form-group">
        <label for="emailBody">Message:</label>
        <textarea id="emailBody" placeholder="Type your message here...">Hello,

This is an important update from the Student Tutor Dashboard team.

Best regards,
STD Team</textarea>
      </div>

      <div class="button-group">
        <button class="btn-secondary" id="cancelEmail">Cancel</button>
        <button class="btn-primary" id="sendEmail">Send Email</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSj8qL6nzQ57q45IRZf5iWzyBPe_9mZwvvYH8zRe4CJdfc92qFTIs67jwv-sfWx6WM3U-tWeM0cDRE9/pub?gid=2014614666&single=true&output=csv";
    // Subjects tab published CSV (column U = Calendar Color; gid must match Subjects sheet)
    let subjectsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vStfM_AuGTHtcz1JzK9zV5JwdFYe9fdtwyAwTt59uK6wbuIjhwHBndHsfXVoq_L8cJ27DFow0RKLSIn/pub?gid=1392008086&single=true&output=csv";

    // *** REPLACE THIS WITH YOUR DEPLOYED WEB APP URL ***
    const EMAIL_BLAST_URL = "https://script.google.com/macros/s/AKfycbw1lUVVDdCiZjmXKig2Wna9oyspSjyiZSfXbn8XQDO6SYrIK4JurUmX7_Af8PFxJKN0/exec";

    // Globals
    let calendar;
    let allEvents = [];
    const tutorHexColor = {}; // from Subjects!U (single source of truth)
    let tutorSubjectsMap = new Map();
    let tutorSubjectsMapLower = new Map();
    let uniqueSubjectTokens = new Set();

    // Shift-click multi-select state for legend
    const multiSelectTutors = new Set();

    function updateConnectionStatus(status){
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.className = `connection-status ${status}`;
      if(status==='connected'){ statusDiv.innerHTML='‚úÖ Calendar loaded successfully'; setTimeout(()=>{statusDiv.style.opacity='0.7';},3000); }
      else if(status==='error'){ statusDiv.innerHTML='‚ö†Ô∏è Failed to load data'; }
      else{ statusDiv.innerHTML='üîÑ Loading calendar...'; }
    }
    function showLoading(){ document.getElementById('loadingOverlay').style.display='flex'; }
    function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }
    function showError(message){
      const calendarContainer=document.querySelector('.calendar-container');
      const errorDiv=document.createElement('div');
      errorDiv.className='error-message';
      errorDiv.innerHTML=`<strong>‚ö†Ô∏è Error</strong><br>${message}<br><small>Please refresh and try again.</small>`;
      calendarContainer.insertBefore(errorDiv,calendarContainer.firstChild);
    }

    // Toast notifications
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // CSV helpers
    function parseCSVRow(row){
      const result=[];let current='';let inQuotes=false;
      for(let i=0;i<row.length;i++){
        const c=row[i],next=row[i+1];
        if(c==='"'){ if(inQuotes && next==='"'){ current+='"'; i++; } else { inQuotes=!inQuotes; } }
        else if(c===',' && !inQuotes){ result.push(current.trim()); current=''; }
        else { current+=c; }
      }
      result.push(current.trim());
      return result;
    }
    async function fetchCSV(url){
      const res=await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status} loading ${url}`);
      return res.text();
    }
    function indexByHeader(headers, wantedNames, fallbackIndex){
      if(headers && headers.length){
        const norm=s=>s.trim().toLowerCase().replace(/\s+/g,'');
        const table=new Map(headers.map((h,idx)=>[norm(h),idx]));
        for(const w of wantedNames){ const idx=table.get(norm(w)); if(idx!=null) return idx; }
      }
      return fallbackIndex;
    }
    function normalizeTutorName(name){ return (name||'').trim().replace(/\s+/g,' '); }
    function normalizeLower(name){ return normalizeTutorName(name).toLowerCase(); }

    // Load Subjects & Colors (single source from column U)
    async function loadSubjectsAndColors(){
      if(!subjectsCSV) return;
      try{
        const text=await fetchCSV(subjectsCSV);
        const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
        if(lines.length===0) return;
        const first=parseCSVRow(lines[0]);
        const hasHeader=first.some(cell=>/first|last|subject|color/i.test(cell));
        let startIndex=0;
        // C=2 First, D=3 Last, T=19 Subjects, U=20 Calendar Color (0-based)
        let cFirst=2,cLast=3,cSubjects=19,cColor=20;
        if(hasHeader){
          const headers=first;
          cFirst=indexByHeader(headers,['First Name','First','Tutor First','TutorFirst','FirstName'],2);
          cLast=indexByHeader(headers,['Last Name','Last','Tutor Last','TutorLast','LastName'],3);
          cSubjects=indexByHeader(headers,['Subjects','Subject','Tutoring Subjects','Tutor Subjects'],19);
          cColor=indexByHeader(headers,['Calendar Color','Color','Event Color'],20);
          startIndex=1;
        }
        const normHex=(s)=>{
          if(!s) return '';
          s=String(s).trim();
          if(/^#[0-9A-Fa-f]{6}$/.test(s)) return s.toUpperCase();
          if(/^[0-9A-Fa-f]{6}$/.test(s)) return ('#'+s).toUpperCase();
          return '';
        };
        for(let i=startIndex;i<lines.length;i++){
          const cols=parseCSVRow(lines[i]);
          const firstName=cols[cFirst]||'';
          const lastName=cols[cLast]||'';
          const subjStr=cols[cSubjects]||'';
          const colorStr=cols[cColor]||'';
          const fullName=normalizeTutorName(`${firstName} ${lastName}`.trim());
          const hex=normHex(colorStr);
          if(fullName){
            tutorSubjectsMap.set(fullName,subjStr);
            tutorSubjectsMapLower.set(normalizeLower(fullName),(subjStr||'').toLowerCase());
            subjStr.split(/[;,/]/).map(s=>s.trim()).filter(Boolean).forEach(tok=>uniqueSubjectTokens.add(tok));
            if(hex) tutorHexColor[fullName]=hex;
          }
        }
      }catch(err){ console.warn('Subjects CSV failed to load:',err.message); }
    }

    // Legend
    function createTutorLegend(tutors){
      const legend=document.getElementById('tutorLegend');
      legend.innerHTML='';
      tutors.forEach(tutor=>{
        const item=document.createElement('div'); item.className='legend-item'; item.dataset.tutor=tutor;
        const color=document.createElement('div'); color.className='legend-color'; color.style.background=getHexForTutor(tutor);
        const label=document.createElement('span'); label.textContent=tutor;
        item.appendChild(color); item.appendChild(label); legend.appendChild(item);

        item.addEventListener('click',(e)=>{
          if(e.shiftKey){
            // Toggle multi-select membership
            if(multiSelectTutors.has(tutor)) multiSelectTutors.delete(tutor); else multiSelectTutors.add(tutor);
            updateLegendSelectionUI();
            applyFiltersUI(); // will respect multi-select
          }else{
            // Single-select behavior, mirror dropdown
            multiSelectTutors.clear();
            updateLegendSelectionUI();
            const sel=document.getElementById('tutorFilter');
            if(sel){ sel.value=tutor; }
            applyFiltersUI();
            document.getElementById('calendar')?.scrollIntoView({behavior:'smooth',block:'start'});
          }
        });
      });
    }
    function updateLegendSelectionUI(){
      document.querySelectorAll('.legend-item').forEach(el=>{
        const t=el.dataset.tutor;
        if(multiSelectTutors.size>0 && multiSelectTutors.has(t)) el.classList.add('selected');
        else el.classList.remove('selected');
      });
    }
    function refreshLegendColors(){
      document.querySelectorAll('.legend-item').forEach(item=>{
        const t=item.dataset.tutor; const box=item.querySelector('.legend-color');
        if(box) box.style.background=getHexForTutor(t);
      });
    }

    // Colors
    function getHexForTutor(name){
      const n=normalizeTutorName(name);
      return tutorHexColor[n] || '#667EEA'; // fallback if missing in sheet
    }
    function applyTutorColors(){
      let styleEl=document.getElementById('tutorColorStyles');
      if(!styleEl){ styleEl=document.createElement('style'); styleEl.id='tutorColorStyles'; document.head.appendChild(styleEl); }
      const tutors=Object.keys(tutorMapFromEvents());
      let css='';
      tutors.forEach(t=>{
        const color=getHexForTutor(t);
        const safe=CSS.escape?CSS.escape(t):t.replace(/["\\]/g,'\\$&');
        css+=`.fc-event[data-tutor="${safe}"]{background:${color}!important;border:none!important;color:#fff}\n`;
      });
      styleEl.textContent=css;
    }
    function tutorMapFromEvents(){
      const map={}; if(!calendar) return map;
      const evts=calendar.getEvents();
      for(let i=0;i<evts.length;i++){ const t=normalizeTutorName(evts[i].extendedProps.tutor||''); if(t) map[t]=true; }
      return map;
    }

    // Get currently visible tutors
    function getVisibleTutors() {
      if (!calendar) return [];
      const visible = new Set();
      const events = calendar.getEvents();
      
      events.forEach(evt => {
        if (evt.display !== 'none') {
          const tutor = evt.extendedProps.tutor;
          if (tutor) visible.add(tutor);
        }
      });
      
      return Array.from(visible).sort();
    }

    // Filters
    function applyFiltersUI(){
      const tutorSelect=document.getElementById('tutorFilter');
      const tutorSelect2=document.getElementById('tutorFilter2');
      const subjectInput=document.getElementById('subjectFilter');

      // If multi-select is active, override dropdown logic entirely
      const multiActive = multiSelectTutors.size>0;

      const t1 = !multiActive && tutorSelect ? tutorSelect.value : 'all';
      const t2Visible = !multiActive && tutorSelect2 && tutorSelect2.style.display!=='none';
      const t2 = (!multiActive && t2Visible && tutorSelect2.value && tutorSelect2.value!=='none') ? tutorSelect2.value : null;

      const q=(subjectInput?.value||'').trim().toLowerCase();
      const doSubject=q.length>=1;
      let allowedLower=null;
      if(doSubject && tutorSubjectsMapLower.size>0){
        allowedLower=new Set();
        tutorSubjectsMapLower.forEach((subjectsLower,tutorLowerName)=>{ if(subjectsLower.includes(q)) allowedLower.add(tutorLowerName); });
      }

      if(!window.calendar) return;

      calendar.batchRendering(()=>{
        const evts=calendar.getEvents();
        for(let i=0;i<evts.length;i++){
          const evt=evts[i];
          const tutor=evt.extendedProps.tutor||'';
          const tutorLower=(evt.extendedProps.tutorLower || tutor.toLowerCase());
          let ok=true;

          if(multiActive){
            ok = multiSelectTutors.has(tutor);
          }else{
            if(t1!=='all' && !t2) ok = (tutor===t1);
            else if(t1!=='all' && t2) ok = (tutor===t1 || tutor===t2);
            else if(t1==='all' && t2) ok = (tutor===t2);
          }

          if(ok && doSubject && allowedLower) ok = allowedLower.has(tutorLower);
          evt.setProp('display', ok ? 'auto' : 'none');
        }
      });

      // Legend emphasis: if multi-select, highlight selected; otherwise emphasize dropdown selection
      const legendItems=document.querySelectorAll('.legend-item');
      if(multiActive){
        legendItems.forEach(item=>{
          const name=item.dataset.tutor;
          item.style.opacity = multiSelectTutors.has(name) ? '1' : '0.35';
        });
      }else{
        const t1cur = tutorSelect ? tutorSelect.value : 'all';
        legendItems.forEach(item=>{
          const name=item.dataset.tutor;
          item.style.opacity = (t1cur==='all' || name===t1cur) ? '1' : '0.35';
        });
      }
    }

    // Availability
    async function loadAvailability(){
      const text=await fetchCSV(sheetCSV);
      const rows=text.split("\n").slice(1);
      let events=[], tutors=new Set();

      rows.forEach(row=>{
        if(!row.trim()) return;
        const cols=parseCSVRow(row);
        if(cols.length<3) return;

        const tutor=normalizeTutorName((cols[0]||'').trim());
        const date=(cols[1]||'').trim();
        const slots=(cols[2]||'').trim();
        if(!tutor || !date) return;

        tutors.add(tutor);

        if(slots && slots!=='Busy all day'){
          slots.split(",").forEach(slot=>{
            const timeRange=slot.trim();
            if(timeRange.includes("-")){
              const [startTime,endTime]=timeRange.split("-").map(t=>t.trim());
              if(startTime && endTime){
                events.push({
                  title:`${tutor} - Available`,
                  start:`${date}T${startTime}`,
                  end:`${date}T${endTime}`,
                  extendedProps:{ tutor, tutorLower:tutor.toLowerCase(), timeSlot:timeRange, originalSlots:slots },
                  backgroundColor:'transparent', borderColor:'transparent',
                  className:'tutor-event', display:'block'
                });
              }
            }
          });
        }
      });

      return {events, tutors: Array.from(tutors)};
    }

    // Suggestions
    function debounce(fn,delay=150){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); }; }
    function updateSubjectSuggestions(query){
      const box=document.getElementById('subjectSuggestions'); if(!box) return;
      const q=(query||'').trim().toLowerCase();
      if(q.length<1 || uniqueSubjectTokens.size===0){ box.style.display='none'; box.innerHTML=''; return; }
      const items=[]; const maxItems=50; const arr=Array.from(uniqueSubjectTokens); let count=0;
      for(let i=0;i<arr.length;i++){ const tok=arr[i]; if(tok && tok.toLowerCase().startsWith(q)){ items.push(tok); if(++count>=maxItems) break; } }
      if(!items.length){ box.style.display='none'; box.innerHTML=''; return; }
      box.innerHTML=items.map(t=>`<div class="item" data-val="${t.replace(/"/g,'&quot;')}">${t}</div>`).join('');
      box.style.display='block';
      box.querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click',()=>{
          const subjectInput=document.getElementById('subjectFilter');
          subjectInput.value=el.getAttribute('data-val'); hideSubjectSuggestions();
        });
      });
      const first=box.querySelector('.item'); if(first){ first.classList.add('active'); }
    }
    function hideSubjectSuggestions(){ const box=document.getElementById('subjectSuggestions'); if(box){ box.style.display='none'; box.innerHTML=''; } }

    // Email Blast Functions
    function openEmailModal() {
      const visibleTutors = getVisibleTutors();
      
      if (visibleTutors.length === 0) {
        showToast('No tutors are currently selected or visible. Please filter or select tutors first.', 'error');
        return;
      }

      // Populate recipient list
      const recipientTags = document.getElementById('recipientTags');
      recipientTags.innerHTML = visibleTutors.map(tutor => 
        `<span class="tutor-tag">${tutor}</span>`
      ).join('');

      // Show modal
      document.getElementById('emailModal').classList.add('show');
    }

    function closeEmailModal() {
      document.getElementById('emailModal').classList.remove('show');
    }

    async function sendEmailBlast() {
      const visibleTutors = getVisibleTutors();
      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();

      // Validation
      if (!subject || !subject.startsWith('STD Email Blast:')) {
        showToast('Subject line must start with "STD Email Blast:"', 'error');
        return;
      }

      if (!body) {
        showToast('Please enter a message body', 'error');
        return;
      }

      if (visibleTutors.length === 0) {
        showToast('No tutors selected', 'error');
        return;
      }

      // Disable send button
      const sendBtn = document.getElementById('sendEmail');
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const response = await fetch(EMAIL_BLAST_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tutors: visibleTutors,
            subject: subject,
            body: body
          })
        });

        const result = await response.json();

        if (result.success) {
          closeEmailModal();
          showToast(`‚úÖ ${result.message}`, 'success');
          
          // Log details
          if (result.sent && result.sent.length > 0) {
            console.log('Successfully sent to:', result.sent);
          }
          if (result.failed && result.failed.length > 0) {
            console.warn('Failed to send to:', result.failed);
          }
        } else {
          showToast(`‚ùå Error: ${result.message}`, 'error');
        }
      } catch (error) {
        console.error('Email blast error:', error);
        showToast(`‚ùå Failed to send emails: ${error.message}`, 'error');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
      }
    }

    // Init
    document.addEventListener("DOMContentLoaded", async function(){
      try{
        updateConnectionStatus('loading'); showLoading();

        // 1) Load Subjects (build subject maps + hex colors)
        await loadSubjectsAndColors();

        // 2) Load Availability (colors already known)
        const {events, tutors}=await loadAvailability();
        allEvents=events;

        // Dropdowns
        const tutorFilter=document.getElementById('tutorFilter');
        tutors.forEach(tutor=>{
          const opt=document.createElement('option'); opt.value=tutor; opt.textContent=tutor; tutorFilter.appendChild(opt);
        });

        // Legend + colors
        createTutorLegend(tutors);

        // Calendar
        const calendarEl=document.getElementById("calendar");
        calendar=new FullCalendar.Calendar(calendarEl,{
          initialView:window.innerWidth<768?'listWeek':'timeGridWeek',
          headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek'},
          height:'auto',
          events:events,
          slotMinTime:'07:00:00',
          slotMaxTime:'23:00:00',
          eventDidMount(info){
            const tutor=normalizeTutorName(info.event.extendedProps.tutor);
            info.el.setAttribute('data-tutor',tutor);
            const hex=getHexForTutor(tutor);
            info.el.style.background=hex; info.el.style.borderColor=hex; info.el.style.color='#fff';
            info.el.setAttribute('title',`${tutor}\nTime: ${info.event.extendedProps.timeSlot}`);
          },
          eventClick(info){
            alert(`Book with ${info.event.extendedProps.tutor}\nTime: ${info.event.extendedProps.timeSlot}`);
          },
          loading(isLoading){ if(isLoading) showLoading(); else hideLoading(); }
        });
        calendar.render();

        applyTutorColors();
        refreshLegendColors();
        updateLegendSelectionUI();

        // Wire filters
        tutorFilter.addEventListener('change', ()=>{
          // Changing dropdown cancels multi-select mode
          multiSelectTutors.clear();
          updateLegendSelectionUI();
          applyFiltersUI();
        });

        const subjectInput=document.getElementById('subjectFilter');
        const applyBtn=document.getElementById('applySubject');
        const clearBtn=document.getElementById('clearSubject');
        const suggBox=document.getElementById('subjectSuggestions');
        const tutorFilter2=document.getElementById('tutorFilter2');
        const toggleTutor2=document.getElementById('toggleTutor2');
        const removeTutor2=document.getElementById('removeTutor2');
        const tutor2Hint=document.getElementById('tutor2Hint');

        applyBtn.addEventListener('click',()=>{ applyFiltersUI(); hideSubjectSuggestions(); });
        subjectInput.addEventListener('keydown',(e)=>{
          if(e.key==='Enter'){ e.preventDefault(); applyFiltersUI(); hideSubjectSuggestions(); }
          else if(e.key==='ArrowDown' || e.key==='ArrowUp'){
            const items=Array.from(document.querySelectorAll('#subjectSuggestions .item')); if(!items.length) return;
            e.preventDefault();
            let idx=items.findIndex(el=>el.classList.contains('active'));
            if(e.key==='ArrowDown') idx=(idx+1)%items.length;
            if(e.key==='ArrowUp')   idx=(idx<=0?items.length-1:idx-1);
            items.forEach(el=>el.classList.remove('active')); items[idx].classList.add('active'); items[idx].scrollIntoView({block:'nearest'});
            subjectInput.value=items[idx].getAttribute('data-val');
          }
        });
        subjectInput.addEventListener('input',debounce(e=>{ updateSubjectSuggestions(e.target.value); },150));
        subjectInput.addEventListener('focus',e=>{ updateSubjectSuggestions(e.target.value); });
        clearBtn.addEventListener('click',()=>{
          subjectInput.value=''; hideSubjectSuggestions();
          if('requestIdleCallback' in window){ requestIdleCallback(()=>applyFiltersUI(),{timeout:200}); } else { setTimeout(()=>applyFiltersUI(),0); }
        });

        // Second tutor toggle (unchanged)
        toggleTutor2.addEventListener('click',()=>{
          if(tutorFilter2.style.display==='none'){
            tutorFilter2.style.display='inline-block'; removeTutor2.style.display='inline-flex'; tutor2Hint.style.display='inline';
            if(tutorFilter2.options.length<=1){
              for(let i=0;i<tutorFilter.options.length;i++){ const opt=tutorFilter.options[i].cloneNode(true); tutorFilter2.appendChild(opt); }
            }
            toggleTutor2.textContent='Second tutor added'; toggleTutor2.disabled=true;
          }
        });
        removeTutor2.addEventListener('click',()=>{
          tutorFilter2.value='none'; tutorFilter2.style.display='none'; removeTutor2.style.display='none'; tutor2Hint.style.display='none';
          toggleTutor2.textContent='Add second tutor'; toggleTutor2.disabled=false; applyFiltersUI();
        });
        tutorFilter2.addEventListener('change',applyFiltersUI);

        // Email Blast Event Listeners
        document.getElementById('emailBlastBtn').addEventListener('click', openEmailModal);
        document.getElementById('closeEmailModal').addEventListener('click', closeEmailModal);
        document.getElementById('cancelEmail').addEventListener('click', closeEmailModal);
        document.getElementById('sendEmail').addEventListener('click', sendEmailBlast);

        // Close modal on overlay click
        document.getElementById('emailModal').addEventListener('click', (e) => {
          if (e.target.id === 'emailModal') closeEmailModal();
        });

        // Close suggestions on outside click
        document.addEventListener('click',(e)=>{
          if(!suggBox) return;
          const within=suggBox.contains(e.target)||e.target===subjectInput;
          if(!within) hideSubjectSuggestions();
        });

        // Responsive view
        function handleResize(){ const v=window.innerWidth<768?'listWeek':'timeGridWeek'; if(calendar.view.type!==v) calendar.changeView(v); }
        window.addEventListener('resize',handleResize);

        updateConnectionStatus('connected');
      }catch(err){
        console.error(err);
        updateConnectionStatus('error');
        showError(err.message||'Failed to initialize calendar.');
      }finally{ hideLoading(); }
    });

    // Shortcuts
    document.addEventListener('keydown',function(e){
      if(!calendar) return;
      if(e.key==='ArrowLeft' && e.ctrlKey){ e.preventDefault(); calendar.prev(); }
      else if(e.key==='ArrowRight' && e.ctrlKey){ e.preventDefault(); calendar.next(); }
      else if(e.key==='Home' && e.ctrlKey){ e.preventDefault(); calendar.today(); }
      // Close modal on Escape
      else if(e.key==='Escape'){
        const modal = document.getElementById('emailModal');
        if(modal && modal.classList.contains('show')) closeEmailModal();
      }
    });

    document.documentElement.style.scrollBehavior='smooth';
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.classList.add('dark-theme'); }
  </script>

  <script>
    /* v9: Subject auto-apply + filters bar (kept) */
    (function(){
      const f1=document.getElementById('tutorFilter');
      const f2=document.getElementById('tutorFilter2');
      const subj=document.getElementById('subjectFilter');
      const searchBtn=document.getElementById('searchBtn');

      const container=(function(){
        if(f1 && f2 && subj){
          let p=f1.parentElement;
          while(p && !(p.contains(f1) && p.contains(f2) && p.contains(subj))) p=p.parentElement;
          return p || (f1 && f1.parentElement) || (subj && subj.parentElement) || null;
        }
        return (f1 && f1.parentElement) || (subj && subj.parentElement) || null;
      })();
      if(container && !container.classList.contains('filters-bar')) container.classList.add('filters-bar');

      if(subj){
        const trigger=()=>{ if(typeof applyFiltersUI==='function') applyFiltersUI(); else if(searchBtn) searchBtn.click(); };
        subj.addEventListener('change',trigger);
        subj.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); trigger(); }});
      }
    })();
  </script>
</body>
</html>
