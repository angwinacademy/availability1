<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Tutor Availability Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:#f5f7fb;margin:0;padding:20px;color:#2d3748}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:0 6px 18px rgba(0,0,0,.07)}
    .header h1{margin:0 0 6px;font-size:24px}
    .filters{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.07);margin-bottom:16px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .filter{display:flex;flex-direction:column;gap:6px;min-width:240px}
    .filter label{font-weight:600;font-size:14px}
    select,input,button{font-size:14px}
    select,input{padding:10px 12px;border:1px solid #cbd5e0;border-radius:10px;background:#fff;color:#2d3748}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #cbd5e0;background:#fff;cursor:pointer}
    .btn:hover{background:#f8fafc}
    #clearSubject.btn{padding:6px 10px;width:36px;height:36px;line-height:1;font-size:16px;display:inline-flex;align-items:center;justify-content:center}
    .calendar{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.07)}
    .legend{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px}
    .legend-item{display:flex;gap:8px;align-items:center;padding:6px 8px;background:#f8fafc;border-radius:8px}
    .legend-swatch{width:14px;height:14px;border-radius:4px}
    .error{background:#fed7d7;color:#742a2a;border:1px solid #feb2b2;padding:10px;border-radius:8px;margin:10px 0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Tutor Availability Calendar</h1>
      <div style="color:#4a5568">View tutor availability and filter by subject</div>
    </div>

    <div class="filters">
      <div class="row">
        <div class="filter">
          <label for="tutorFilter">Filter by tutor</label>
          <select id="tutorFilter">
            <option value="all">All tutors</option>
          </select>
        </div>

        <div class="filter" style="min-width:360px">
          <label for="subjectFilter">Filter by subject (type, then Search or Enter)</label>
          <div class="row" style="gap:8px">
            <input id="subjectFilter" placeholder="e.g., algebra, biology, essay" autocomplete="off" />
            <button id="applySubject" class="btn" title="Search">Search</button>
            <button id="clearSubject" class="btn" title="Clear subject">×</button>
          </div>
          <div style="font-size:12px;color:#718096">Matching is case-insensitive and uses contains; typing “alg” matches “Algebra 1”, “Algebra 2”, etc.</div>
        </div>
      </div>
    </div>

    <div class="calendar">
      <div id="calendar"></div>
      <div class="legend" id="legend"></div>
      <div id="errorBox" class="error" style="display:none"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Existing availability CSV (already working in your original file)
    const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSj8qL6nzQ57q45IRZf5iWzyBPe_9mZwvvYH8zRe4CJdfc92qFTIs67jwv-sfWx6WM3U-tWeM0cDRE9/pub?gid=2014614666&single=true&output=csv";

    // NEW: Subjects sheet (publish the Subjects tab as CSV and paste URL here)
    // If you don’t have the URL yet, leave this as-is and it will only enable the UI once set.
    let subjectsCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vStfM_AuGTHtcz1JzK9zV5JwdFYe9fdtwyAwTt59uK6wbuIjhwHBndHsfXVoq_L8cJ27DFow0RKLSIn/pub?gid=1392008086&single=true&output=csv"; // e.g., "https://docs.google.com/spreadsheets/d/e/.../pub?gid=<SUBJECTS_GID>&single=true&output=csv"

    // If you’re testing with a static CSV (like the one you attached), you can host it and point the URL here.
    
    // ==== STATE ====
    let calendar;
    let tutorColors = {};
    let allEvents = [];
    const tutorSubjectsMap = new Map();       // "First Last" -> Subjects (original)
    const tutorSubjectsMapLower = new Map();  // "first last" -> subjects (lowercased)
    const colorSchemes = [
      '#667eea','#38a169','#ed8936','#e53e3e','#d69e2e',
      '#6b46c1','#319795','#2c5282','#9b2c2c','#0077b6'
    ];

    // ==== UTILS ====
    function showError(msg) {
      const el = document.getElementById('errorBox');
      el.style.display = 'block';
      el.textContent = msg;
    }
    function parseCSVRow(row){
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<row.length;i++){
        const c=row[i], n=row[i+1];
        if(c==='"'){ if(q && n==='"'){ cur+='"'; i++; } else { q=!q; } }
        else if(c===',' && !q){ out.push(cur.trim()); cur=''; }
        else { cur+=c; }
      }
      out.push(cur.trim()); return out;
    }
    async function fetchCSV(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status} loading CSV`);
      return res.text();
    }

    // ==== SUBJECTS MAP ====
    function buildSubjectsMapFromCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      if(!lines.length) return;

      const first = parseCSVRow(lines[0]);
      const looksLikeHeader = first.some(c => /first|last|subject/i.test(c));
      let startIdx=0, cFirst=2, cLast=3, cSubjects=19; // C,D,T default (0-based)
      if(looksLikeHeader){
        const h = first.map(s=>s.toLowerCase().replace(/\s+/g,''));
        const find = names => {
          for(const n of names){ const idx = h.indexOf(n.toLowerCase().replace(/\s+/g,'')); if(idx>-1) return idx; }
          return -1;
        };
        cFirst    = find(['firstname','first','tutorfirst'])   !== -1 ? find(['firstname','first','tutorfirst'])   : 2;
        cLast     = find(['lastname','last','tutorlast'])       !== -1 ? find(['lastname','last','tutorlast'])     : 3;
        cSubjects = find(['subjects','subject','tutorsubjects'])!== -1 ? find(['subjects','subject','tutorsubjects']): 19;
        startIdx = 1;
      }

      for(let i=startIdx;i<lines.length;i++){
        const cols = parseCSVRow(lines[i]);
        const firstName = cols[cFirst] || '';
        const lastName  = cols[cLast] || '';
        const subjStr   = cols[cSubjects] || '';
        const fullName  = `${firstName} ${lastName}`.trim().replace(/\s+/g,' ');
        if(!fullName) continue;
        tutorSubjectsMap.set(fullName, subjStr);
        tutorSubjectsMapLower.set(fullName.toLowerCase(), (subjStr||'').toLowerCase());
      }
    }

    // ==== AVAILABILITY -> EVENTS ====
    async function loadAvailability(){
      const text = await fetchCSV(sheetCSV);
      const rows = text.split(/\r?\n/);
      const header = rows.shift(); // discard header
      const tutorsSet = new Set();
      const events = [];
      let colorIdx = 0;

      for(const row of rows){
        if(!row || !row.trim()) continue;
        const cols = parseCSVRow(row);
        if(cols.length < 3) continue;

        const tutor = (cols[0]||'').trim();
        const date  = (cols[1]||'').trim();
        const slots = (cols[2]||'').trim();

        if(!tutor || !date) continue;
        tutorsSet.add(tutor);
        if(!tutorColors[tutor]) { tutorColors[tutor] = colorSchemes[colorIdx % colorSchemes.length]; colorIdx++; }

        if(slots && slots.toLowerCase() !== 'busy all day'){
          const chunks = slots.split(',').map(s=>s.trim()).filter(Boolean);
          for(const chunk of chunks){
            if(!chunk.includes('-')) continue;
            const [startTime,endTime] = chunk.split('-').map(s=>s.trim());
            if(!startTime || !endTime) continue;
            events.push({
              title: `${tutor} - Available`,
              start: `${date}T${startTime}`,
              end:   `${date}T${endTime}`,
              backgroundColor: tutorColors[tutor],
              borderColor: tutorColors[tutor],
              display: 'block',
              extendedProps: {
                tutor,
                tutorLower: tutor.toLowerCase(),
                timeSlot: chunk,
                originalSlots: slots
              }
            });
          }
        }
      }
      return { events, tutors: Array.from(tutorsSet) };
    }

    function renderLegend(tutors){
      const wrap = document.getElementById('legend');
      wrap.innerHTML = '';
      tutors.forEach(t => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        const sw = document.createElement('div');
        sw.className = 'legend-swatch';
        sw.style.background = tutorColors[t];
        const name = document.createElement('div');
        name.textContent = t;
        item.appendChild(sw); item.appendChild(name);
        wrap.appendChild(item);
      });
    }

    // ==== FILTERING ====
    function applyFiltersUI() {
      const tutorSelect  = document.getElementById('tutorFilter');
      const subjectInput = document.getElementById('subjectFilter');

      const selectedTutor = tutorSelect ? tutorSelect.value : 'all';
      const q = (subjectInput?.value || '').trim().toLowerCase();
      const doSubject = q.length >= 2;

      let allowedTutors = null;
      if (doSubject) {
        allowedTutors = new Set();
        tutorSubjectsMapLower.forEach((subjectsLower, tutorLowerName) => {
          if (subjectsLower.includes(q)) allowedTutors.add(tutorLowerName);
        });
      }

      calendar.batchRendering(() => {
        const evts = calendar.getEvents();
        for (let i=0; i<evts.length; i++) {
          const evt = evts[i];
          const tutor = evt.extendedProps.tutor;
          const tutorLower = evt.extendedProps.tutorLower;

          let ok = (selectedTutor === 'all' || tutor === selectedTutor);
          if (ok && doSubject) {
            ok = allowedTutors.has(tutorLower);
          }
          evt.setProp('display', ok ? 'auto' : 'none');
        }
      });

      // legend emphasis only for tutor dropdown
      const legendItems = document.querySelectorAll('.legend-item');
      for (let i=0; i<legendItems.length; i++){
        const item = legendItems[i];
        const name = item.textContent.trim();
        const match = (selectedTutor === 'all' || name === selectedTutor);
        item.style.opacity = match ? '1' : '0.35';
      }
    }

    // ==== INIT ====
    document.addEventListener('DOMContentLoaded', async () => {
      try{
        // Load availability
        const { events, tutors } = await loadAvailability();
        allEvents = events;

        // Load subjects (optional but needed for subject filter)
        if (subjectsCSV && subjectsCSV.startsWith('http')) {
          try {
            const txt = await fetchCSV(subjectsCSV);
            buildSubjectsMapFromCSV(txt);
          } catch (e) {
            console.warn('Subjects CSV load failed:', e.message);
          }
        }

        // Fill tutor dropdown
        const tutorFilter = document.getElementById('tutorFilter');
        tutors.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.textContent = t;
          tutorFilter.appendChild(opt);
        });

        // Calendar
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek',
          headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
          height: 'auto',
          events: allEvents,
          slotMinTime: '07:00:00',
          slotMaxTime: '23:00:00',
          eventDidMount(info){
            info.el.setAttribute('title', `${info.event.extendedProps.tutor}\n${info.event.extendedProps.timeSlot}`);
          }
        });
        calendar.render();

        // Wire up filters (apply only on Search click or Enter)
        const subjectInput = document.getElementById('subjectFilter');
        const applyBtn     = document.getElementById('applySubject');
        const clearBtn     = document.getElementById('clearSubject');

        tutorFilter.addEventListener('change', applyFiltersUI);

        applyBtn.addEventListener('click', () => applyFiltersUI());

        subjectInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            applyFiltersUI();
          }
        });

        clearBtn.addEventListener('click', () => {
          subjectInput.value = '';
          applyFiltersUI();
        });

        renderLegend(tutors);
      }catch(err){
        console.error(err);
        showError(err.message || 'Failed to initialize.');
      }
    });
  </script>
</body>
</html>
